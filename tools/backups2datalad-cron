#!/bin/bash
source "$(dirname "$0")"/backups2datalad-cron-common

(
eval python -m tools.backups2datalad \
   -l WARNING \
   --backup-root "$backup_root" \
   --config tools/backups2datalad.cfg.yaml \
   update-from-backup \
   -e '000(108|23[5678])$' \
   "$*" 2>&1 | grep -v 'nothing to save, working tree clean'

git pull --commit --no-edit
datalad push -J 5

python -m tools.backups2datalad \
   -l DEBUG \
   --backup-root "$backup_root" \
   --config tools/backups2datalad.cfg.yaml \
   populate "$@"

git pull --commit --no-edit
datalad push -J 5

python -m tools.backups2datalad \
   -l DEBUG \
   --backup-root "$backup_root" \
   --config tools/backups2datalad.cfg.yaml \
   populate-zarrs

git pull --commit --no-edit  # so we possibly merge changes on the server
datalad push -J 5
) 2>|.git/tmp/stderr

if [ -s .git/tmp/stderr ]; then
	echo "There was stderr from backup/datalad invocations:"
	cat .git/tmp/stderr
fi

# we must be clean
git diff --exit-code
